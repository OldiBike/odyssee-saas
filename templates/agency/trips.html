{% extends "base.html" %}

{% block title %}Mes Voyages - {{ g.agency.name }}{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .status-proposed {
        background-color: #FEF3C7;
        color: #92400E;
    }
    .status-assigned {
        background-color: #EDE9FE;
        color: #5B21B6;
    }
    .status-sold {
        background-color: #D1FAE5;
        color: #065F46;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-plane text-blue-600 mr-2"></i>
                Mes Voyages
            </h1>
            <p class="text-gray-600">G√©rez tous vos voyages cr√©√©s</p>
        </div>
        <a href="{{ url_for('generate_trip') }}" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center">
            <i class="fas fa-plus mr-2"></i>
            Nouveau Voyage
        </a>
    </div>

    <!-- Filtres -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
        <div class="flex flex-wrap gap-4">
            <select id="filter-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Tous les statuts</option>
                <option value="proposed">Propos√©s</option>
                <option value="assigned">Assign√©s</option>
                <option value="sold">Vendus</option>
            </select>
            
            <select id="filter-type" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="">Tous les types</option>
                <option value="sejour">S√©jours</option>
                <option value="day_trip">Excursions</option>
            </select>
            
            <input type="text" id="search-destination" placeholder="Rechercher destination..." 
                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 flex-1">
            
            <button onclick="filterTrips()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                <i class="fas fa-filter mr-2"></i>Filtrer
            </button>
        </div>
    </div>

    <!-- Liste des voyages -->
    <div id="trips-container" class="bg-white rounded-xl shadow-md overflow-hidden">
        <!-- Loading -->
        <div id="loading-trips" class="text-center py-12">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"></div>
            <p class="text-gray-600 mt-4">Chargement des voyages...</p>
        </div>

        <!-- Table (sera remplie par JS) -->
        <div id="trips-table" class="hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voyage</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trips-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Sera rempli dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="hidden text-center py-12">
            <i class="fas fa-plane-slash text-gray-300 text-6xl mb-4"></i>
            <p class="text-gray-600 text-xl mb-2">Aucun voyage trouv√©</p>
            <p class="text-gray-500">Commencez par cr√©er votre premier voyage</p>
            <a href="{{ url_for('generate_trip') }}" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                Cr√©er un voyage
            </a>
        </div>
    </div>
</div>

<!-- Modal Actions -->
<div id="action-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Actions du voyage</h3>
        <div id="modal-content">
            <!-- Contenu dynamique -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let trips = [];

document.addEventListener('DOMContentLoaded', loadTrips);

async function loadTrips() {
    try {
        const response = await fetch('/api/trips');
        trips = await response.json();
        renderTrips(trips);
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('loading-trips').innerHTML = `
            <div class="text-red-600">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p>Erreur lors du chargement</p>
            </div>
        `;
    }
}

function renderTrips(tripsList) {
    const loading = document.getElementById('loading-trips');
    const table = document.getElementById('trips-table');
    const empty = document.getElementById('empty-state');
    const tbody = document.getElementById('trips-tbody');
    
    loading.classList.add('hidden');
    
    if (tripsList.length === 0) {
        empty.classList.remove('hidden');
        return;
    }
    
    table.classList.remove('hidden');
    
    tbody.innerHTML = tripsList.map(trip => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
                <div>
                    <div class="text-sm font-medium text-gray-900">${trip.destination}</div>
                    <div class="text-sm text-gray-500">${trip.hotel_name || 'Sans h√©bergement'}</div>
                </div>
            </td>
            <td class="px-6 py-4">
                <span class="text-sm text-gray-600">
                    ${trip.is_day_trip ? 'üåÖ Excursion' : 'üè® S√©jour'}
                </span>
            </td>
            <td class="px-6 py-4">
                ${trip.client_full_name ? `
                    <div class="text-sm">
                        <div class="font-medium text-gray-900">${trip.client_full_name}</div>
                        <div class="text-gray-500">${trip.client_email || ''}</div>
                    </div>
                ` : '<span class="text-sm text-gray-400">Non assign√©</span>'}
            </td>
            <td class="px-6 py-4">
                <span class="text-lg font-bold text-gray-900">${trip.price} ‚Ç¨</span>
            </td>
            <td class="px-6 py-4">
                <span class="status-badge status-${trip.status}">
                    ${trip.status === 'proposed' ? 'üìù Propos√©' :
                      trip.status === 'assigned' ? 'üë§ Assign√©' : 
                      '‚úÖ Vendu'}
                </span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">
                ${trip.created_at}
            </td>
            <td class="px-6 py-4 text-right">
                <button onclick="showActions(${trip.id})" class="text-blue-600 hover:text-blue-900">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function filterTrips() {
    const status = document.getElementById('filter-status').value;
    const type = document.getElementById('filter-type').value;
    const search = document.getElementById('search-destination').value.toLowerCase();
    
    let filtered = trips;
    
    if (status) {
        filtered = filtered.filter(t => t.status === status);
    }
    
    if (type) {
        filtered = filtered.filter(t => type === 'day_trip' ? t.is_day_trip : !t.is_day_trip);
    }
    
    if (search) {
        filtered = filtered.filter(t => 
            t.destination.toLowerCase().includes(search) ||
            (t.hotel_name && t.hotel_name.toLowerCase().includes(search))
        );
    }
    
    renderTrips(filtered);
}

function showActions(tripId) {
    const trip = trips.find(t => t.id === tripId);
    const modal = document.getElementById('action-modal');
    const content = document.getElementById('modal-content');
    
    content.innerHTML = `
        <div class="space-y-3">
            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-eye mr-2"></i> Voir d√©tails
            </button>
            ${trip.status === 'proposed' ? `
                <button class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-user-plus mr-2"></i> Assigner un client
                </button>
            ` : ''}
            ${trip.status === 'assigned' ? `
                <button class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg">
                    <i class="fas fa-check mr-2"></i> Marquer comme vendu
                </button>
            ` : ''}
            <button class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-download mr-2"></i> T√©l√©charger PDF
            </button>
            <button onclick="closeModal()" class="w-full text-left px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                Fermer
            </button>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('action-modal').classList.add('hidden');
}
</script>
{% endblock %}