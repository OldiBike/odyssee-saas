{% extends "base.html" %}

{% block title %}Cr√©ation Manuelle - {{ g.agency.name }}{% endblock %}

{% block extra_css %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <style>
        .form-container { padding: 40px; }
        .form-group { margin-bottom: 25px; width: 100%; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3B82F6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .form-row { display: flex; gap: 20px; }
        .save-btn { background: #3B82F6; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; width: 100%; }
        h3.section-divider { text-align: center; border-bottom: 1px solid #e5e7eb; line-height: 0.1em; margin: 40px 0 30px; }
        h3.section-divider span { background:#fff; padding:0 15px; color: #6b7280; font-size: 0.9em; text-transform: uppercase; font-weight: 600; }
        .conditional-fields { background: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; margin-top: 1rem; border: 1px solid #e5e7eb; }
        .hidden { display: none; }
        @media (max-width: 768px) { .form-row { flex-direction: column; gap: 0; } .form-container { padding: 20px; } }
        .pac-container { z-index: 10000 !important; }
    </style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow-lg overflow-hidden max-w-4xl mx-auto">
    <div class="form-container">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                    Cr√©ation Manuelle de Voyage
                </h1>
                <p class="text-gray-600">Remplissez les champs pour cr√©er une nouvelle proposition.</p>
            </div>
            <a href="{{ url_for('generate_trip') }}" class="text-sm text-blue-600 hover:underline">
                ‚Üê Retour au mode IA
            </a>
        </div>

        <form id="manual-trip-form">

            <h3 class="section-divider"><span>Informations G√©n√©rales</span></h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="destination">üìç Destination *</label>
                    <input type="text" id="destination" class="form-control" required placeholder="Saisir une destination...">
                </div>
            </div>
            <div class="form-group">
                <label>üìÖ Type de Voyage</label>
                <div class="flex space-x-4 mt-2">
                    <label class="flex items-center"><input type="radio" name="trip_type" value="sejour" checked class="mr-2"> S√©jour avec h√©bergement</label>
                    <label class="flex items-center"><input type="radio" name="trip_type" value="day_trip" class="mr-2"> Excursion d'un jour</label>
                </div>
            </div>

            <div id="sejour-fields">
                <h3 class="section-divider"><span>üè® H√©bergement & Dates</span></h3>
                <div class="form-row">
                    <div class="form-group"><label for="hotel_name">Nom de l'h√¥tel</label><input type="text" id="hotel_name" placeholder="Saisir un nom d'h√¥tel..."></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="date_range">P√©riode du s√©jour</label><input type="text" id="date_range" readonly placeholder="Cliquez pour choisir les dates"><input type="hidden" id="date_start" name="date_start"><input type="hidden" id="date_end" name="date_end"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="stars">‚≠ê Cat√©gorie</label><select id="stars"><option value="3">3 ‚òÖ</option><option value="4" selected>4 ‚òÖ</option><option value="5">5 ‚òÖ</option></select></div>
                    <div class="form-group"><label for="meal_plan">üçΩÔ∏è Formule</label><select id="meal_plan"><option value="petit_dejeuner">Petit-d√©jeuner</option><option value="demi_pension">Demi-pension</option><option value="pension_complete">Pension compl√®te</option><option value="all_in">All Inclusive</option></select></div>
                </div>
            </div>

            <div id="daytrip-fields" class="hidden">
                <h3 class="section-divider"><span>‚è∞ Horaires de l'excursion</span></h3>
                <div class="form-row">
                    <div class="form-group"><label for="departure_time">Heure de d√©part</label><input type="time" id="departure_time" value="08:00"></div>
                    <div class="form-group"><label for="return_time">Heure de retour</label><input type="time" id="return_time" value="20:00"></div>
                </div>
            </div>

            <h3 class="section-divider"><span>‚úàÔ∏è Transport</span></h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="transport_type">Moyen de transport</label>
                    <select id="transport_type">
                        <option value="avion">Avion</option>
                        <option value="train">Train</option>
                        <option value="autocar">Autocar</option>
                        <option value="voiture">Voiture</option>
                    </select>
                </div>
            </div>
            <div id="autocar-fields" class="conditional-fields hidden">
                <div class="form-group mb-0">
                    <label for="bus_departure_address">Point de d√©part de l'autocar</label>
                    <input type="text" id="bus_departure_address" placeholder="Ex: Place de la Gare, Bruxelles">
                </div>
            </div>

            <h3 class="section-divider"><span>üí∞ Tarification & Participants</span></h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="pack_price">üì¶ Prix du pack (‚Ç¨) *</label>
                    <input type="number" id="pack_price" required placeholder="ex: 2400">
                </div>
                <div class="form-group">
                    <label for="num_people">üë• Nombre de personnes</label>
                    <input type="number" id="num_people" value="2" min="1">
                </div>
            </div>

            <div class="mt-12">
                <button type="submit" class="save-btn">üöÄ Sauvegarder le Voyage</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<script>
    function initManualForm() {
        // Fonction utilitaire pour √©chapper le HTML (doit √™tre d√©finie avant d'√™tre utilis√©e)
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialisation des autocompl√©tions via l'API proxy (s√©curis√©)
        initAutocomplete('hotel_name', 'establishment');
        initAutocomplete('destination', '(cities)');
        
        function initAutocomplete(inputId, types) {
            const input = document.getElementById(inputId);
            const resultsDiv = document.createElement('div');
            resultsDiv.className = 'autocomplete-results';
            resultsDiv.style.cssText = 'position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
            input.parentElement.style.position = 'relative';
            input.parentElement.appendChild(resultsDiv);
            
            let debounceTimer;
            input.addEventListener('keyup', async (e) => {
                clearTimeout(debounceTimer);
                const query = e.target.value;
                
                if (query.length < 3) {
                    resultsDiv.style.display = 'none';
                    return;
                }
                
                debounceTimer = setTimeout(async () => {
                    try {
                        const response = await fetchWithCSRF('/api/google/autocomplete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ input: query })
                        });
                        const data = await response.json();
                        
                        if (data.success && data.predictions.length > 0) {
                            resultsDiv.innerHTML = data.predictions.map(p => `
                                <div class="autocomplete-item" style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" 
                                     data-description="${escapeHtml(p.description)}">
                                    <strong>${escapeHtml(p.structured_formatting.main_text)}</strong><br>
                                    <small>${escapeHtml(p.structured_formatting.secondary_text || '')}</small>
                                </div>
                            `).join('');
                            resultsDiv.style.display = 'block';
                        } else {
                            resultsDiv.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Erreur autocompl√©tion:', error);
                    }
                }, 300);
            });
            
            resultsDiv.addEventListener('click', async (e) => {
                const item = e.target.closest('.autocomplete-item');
                if (item) {
                    const description = item.dataset.description;
                    input.value = description;
                    resultsDiv.style.display = 'none';
                    
                    // Si c'est l'h√¥tel, extraire la ville et remplir la destination
                    if (inputId === 'hotel_name') {
                        await extractCityFromHotel(description);
                    }
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        // Fonction pour extraire la ville depuis la description de l'h√¥tel
        async function extractCityFromHotel(hotelDescription) {
            // Format typique: "Nom de l'h√¥tel, Rue, Ville, Pays"
            // On prend la partie avant la derni√®re virgule (g√©n√©ralement la ville)
            const parts = hotelDescription.split(',').map(p => p.trim());
            
            if (parts.length >= 2) {
                // Prendre l'avant-derni√®re partie (souvent la ville)
                const city = parts[parts.length - 2];
                const destinationInput = document.getElementById('destination');
                
                // Ne remplir que si le champ destination est vide
                if (!destinationInput.value || destinationInput.value.trim() === '') {
                    destinationInput.value = city;
                }
            }
        }

        // Initialisation du s√©lecteur de dates
        const dateRangePicker = new Litepicker({
            element: document.getElementById('date_range'),
            singleMode: false, 
            lang: 'fr-FR', 
            format: 'DD MMMM YYYY',
            setup: (picker) => {
                picker.on('selected', (date1, date2) => {
                    const formatDate = (d) => d.toISOString().split('T')[0];
                    document.getElementById('date_start').value = formatDate(date1.dateInstance);
                    document.getElementById('date_end').value = formatDate(date2.dateInstance);
                });
            },
        });

        const tripTypeRadios = document.querySelectorAll('input[name="trip_type"]');
        const transportSelect = document.getElementById('transport_type');
        
        function toggleFields() {
            const isDayTrip = document.querySelector('input[name="trip_type"]:checked').value === 'day_trip';
            
            document.getElementById('sejour-fields').classList.toggle('hidden', isDayTrip);
            document.getElementById('daytrip-fields').classList.toggle('hidden', !isDayTrip);
            
            if(isDayTrip) {
                transportSelect.value = 'autocar';
                transportSelect.disabled = true;
            } else {
                transportSelect.disabled = false;
            }
            toggleAutocarFields();
        }
        
        function toggleAutocarFields() {
            const isAutocar = transportSelect.value === 'autocar';
            document.getElementById('autocar-fields').classList.toggle('hidden', !isAutocar);
        }

        tripTypeRadios.forEach(radio => radio.addEventListener('change', toggleFields));
        transportSelect.addEventListener('change', toggleAutocarFields);

        // Gestion de la soumission du formulaire
        document.getElementById('manual-trip-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const isDayTrip = document.querySelector('input[name="trip_type"]:checked').value === 'day_trip';
            const saveBtn = e.target.querySelector('button[type="submit"]');
            const originalText = saveBtn.innerHTML;
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'Sauvegarde en cours...';

            // Rassembler les donn√©es du formulaire
            const formData = {
                is_day_trip: isDayTrip,
                destination: document.getElementById('destination').value,
                hotel_name: isDayTrip ? '' : document.getElementById('hotel_name').value,
                transport_type: document.getElementById('transport_type').value,
                bus_departure_address: document.getElementById('bus_departure_address').value,
                date_start: isDayTrip ? null : document.getElementById('date_start').value,
                date_end: isDayTrip ? null : document.getElementById('date_end').value,
                stars: isDayTrip ? null : document.getElementById('stars').value,
                meal_plan: isDayTrip ? null : document.getElementById('meal_plan').value,
                departure_time: isDayTrip ? document.getElementById('departure_time').value : null,
                return_time: isDayTrip ? document.getElementById('return_time').value : null,
                pack_price: document.getElementById('pack_price').value,
                num_people: document.getElementById('num_people').value,
            };

            try {
                // Envoyer les donn√©es √† l'API
                const response = await fetchWithCSRF('/api/trips', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ form_data: formData, status: 'proposed' })
                });

                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Voyage sauvegard√© avec succ√®s !');
                    window.location.href = '/agency/trips'; // Redirection
                } else {
                    alert('‚ùå Erreur: ' + (result.message || 'Une erreur inconnue est survenue.'));
                }
            } catch (error) {
                console.error('Erreur de soumission:', error);
                alert('‚ùå Erreur de connexion au serveur.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        });

        // Initialiser l'√©tat des champs dynamiques
        toggleFields();
    }
    
    // Appeler la fonction d'initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', initManualForm);
</script>
{% endblock %}
